{% extends "base.html" %}
{% block title %}Edit Experience — ReqSense{% endblock %}

{% block content %}
<div class="table-card" style="max-width:980px;margin:1.25rem auto;">
  <div class="table-header">
    <h2>Edit Experience</h2>
    <div><a class="btn secondary" href="{{ url_for('experiences.overview') }}">Back</a></div>
  </div>

  <form method="post" style="padding:1rem;display:grid;gap:1rem">
    <div class="form-grid">
      <div>
        <div class="form-field">
          <label for="narrative" style="font-weight:700">Narrative</label>
          <textarea id="narrative" name="narrative_text" required maxlength="5000">{{ experience.narrative_text }}</textarea>
          <div style="display:flex;justify-content:space-between">
            <small class="muted">Give enough context for a requirement to be derived.</small>
            <small id="char-count" class="small muted">0 / 5000</small>
          </div>
        </div>

        <div class="form-field">
          <label for="current_workaround" style="font-weight:700">Current workaround</label>
          <textarea id="current_workaround" name="current_workaround">{{ experience.current_workaround or '' }}</textarea>
        </div>
      </div>

      <aside>
        <div class="form-field">
          <label for="stakeholder" style="font-weight:700">Stakeholder</label>
          <select id="stakeholder" name="stakeholder_id">
            <option value="">(none)</option>
            {% for s in stakeholders %}
            <option value="{{ s.id }}" {% if experience.stakeholder_id==s.id %}selected{% endif %}>{{ s.name }}{% if s.role %} — {{ s.role }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-field">
          <label for="impact_severity" style="font-weight:700">Impact severity</label>
          <select id="impact_severity" name="impact_severity">
            <option value="">Select</option>
            {% for level in ['Low','Medium','High','Critical'] %}
            <option value="{{ level }}" {% if experience.impact_severity==level %}selected{% endif %}>{{ level }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-field">
          <label style="font-weight:700">Context tags</label>
          <div id="tag-input" style="display:flex;flex-wrap:wrap;gap:.4rem;padding:.45rem;border-radius:8px;border:1px solid rgba(2,6,23,0.04);background:#fff">
            <input id="tag-box" type="text" placeholder="Add tag and press Enter" style="flex:1;border:0;outline:none;padding:.25rem;min-width:120px" />
            {% if experience.context_tags %}
              {% for t in experience.context_tags %}
                <span class="badge tag-badge">{{ t }}<button type="button" onclick="this.parentElement.remove()">✕</button></span>
              {% endfor %}
            {% endif %}
          </div>
          <input type="hidden" id="context_tags" name="context_tags" value="{{ (experience.context_tags | join(',')) if experience.context_tags else '' }}">
        </div>

        <div style="margin-top:.6rem">
          <label class="small muted">Options</label>
          <div style="display:flex;gap:.5rem;margin-top:.35rem">
            <button type="submit" class="btn">Save</button>
            <a class="btn secondary" href="{{ url_for('experiences.overview') }}">Cancel</a>
          </div>
        </div>
      </aside>
    </div>
  </form>
</div>

<script>
(function(){
  const ta = document.getElementById('narrative');
  const cc = document.getElementById('char-count');
  if(ta && cc){
    ta.addEventListener('input', ()=> cc.textContent = ta.value.length + ' / 5000');
    cc.textContent = (ta.value || '').length + ' / 5000';
  }
  // tag handling mirrors submit page – keep same JS if desired
})();
</script>
{% endblock %}