{% extends "base.html" %}

{% block title %}Experiences — ReqSense{% endblock %}

{% block content %}
<div class="table-card">
  <div class="table-header">
    <h2>Experiences</h2>
    <div>
      <a class="btn" href="{{ url_for('experiences.submit_experience') }}">Submit Experience</a>
      <a class="btn" href="{{ url_for('experiences.traceability') }}" style="background:#fff;color:var(--accent);margin-left:.6rem;border:1px solid rgba(15,23,36,0.04)">Traceability</a>
    </div>
  </div>

  <div style="padding:1rem">
    <div class="table-responsive">
      <table id="experiences-table" class="table">
        <thead>
          <tr>
            <th><button class="sort-btn" data-col="0" data-type="num"># <span class="sort-indicator"></span></button></th>
            <th><button class="sort-btn" data-col="1" data-type="text">Experience ID <span class="sort-indicator"></span></button></th>
            <th><button class="sort-btn" data-col="2" data-type="text">Summary <span class="sort-indicator"></span></button></th>
            <th><button class="sort-btn" data-col="3" data-type="text">Stakeholder <span class="sort-indicator"></span></button></th>
            <th><button class="sort-btn" data-col="4" data-type="text">Tags <span class="sort-indicator"></span></button></th>
            <th><button class="sort-btn" data-col="5" data-type="text">Impact <span class="sort-indicator"></span></button></th>
            <th><button class="sort-btn" data-col="6" data-type="date">Created <span class="sort-indicator"></span></button></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for e in experiences %}
          <tr>
            <td>{{ e.id }}</td>
            <td>{{ e.experience_id or ('#' ~ e.id) }}</td>
            <td class="summary-cell">
              <div class="text-truncate">{{ (e.narrative_text[:180] ~ ('...' if e.narrative_text|length > 180 else '')) }}</div>
            </td>
            <td class="stakeholder-cell">
              {% if e.stakeholder %}
                <div><strong>{{ e.stakeholder.name }}</strong></div>
                <div class="small muted">{{ e.stakeholder.role or '' }}</div>
              {% else %}
                <small class="muted">—</small>
              {% endif %}
            </td>
            <td>
              {% for t in (e.context_tags or []) %}
                <span class="badge">{{ t }}</span>
              {% else %}
                <small class="muted">—</small>
              {% endfor %}
            </td>
            <td>{{ e.impact_severity or '—' }}</td>
            <td data-sort="{{ e.created_at.isoformat() if e.created_at }}">{{ e.created_at.strftime('%Y-%m-%d %H:%M') if e.created_at else '—' }}</td>
            <td>
              <a href="{{ url_for('experiences.edit_experience', experience_id=e.id) }}">Edit</a>
              <span style="margin:0 .5rem">•</span>
              <a href="{{ url_for('experiences.traceability') }}#exp-{{ e.id }}">Trace</a>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="8">No experiences yet.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
.sort-btn{background:none;border:0;cursor:pointer;font-weight:700;padding:0}
.sort-indicator{display:inline-block;width:0.8rem;margin-left:.3rem}
.sort-indicator.asc::after{content:"▲";color:var(--accent);font-size:.7rem}
.sort-indicator.desc::after{content:"▼";color:var(--accent);font-size:.7rem}

/* make header cell clickable and accessible */
thead th { user-select: none; }
thead th.sortable { cursor: pointer; }
.sort-btn { display:inline-flex; align-items:center; gap:.35rem; }
.sort-btn:focus { outline: 3px solid rgba(13,110,253,0.18); border-radius:6px; }
</style>

<script>
(function(){
  const table = document.getElementById('experiences-table');
  if(!table) return;
  const tbody = table.tBodies[0];

  function normalizeCell(cell){
    if(!cell) return '';
    if(cell.dataset && cell.dataset.sort) return cell.dataset.sort;
    const badges = cell.querySelectorAll && cell.querySelectorAll('.badge');
    if(badges && badges.length) return Array.from(badges).map(b=>b.textContent.trim()).join(', ');
    const strong = cell.querySelector && cell.querySelector('strong');
    if(strong) return strong.textContent.trim() + ' ' + cell.textContent.replace(strong.textContent,'').trim();
    return cell.textContent.trim();
  }

  function sortTable(colIndex, type='text', asc=true){
    const rows = Array.from(tbody.rows);
    rows.sort((a,b)=>{
      let A = normalizeCell(a.cells[colIndex]), B = normalizeCell(b.cells[colIndex]);
      if(type==='num'){A = parseFloat(A)||0; B = parseFloat(B)||0; return asc?A-B:B-A}
      if(type==='date'){A = Date.parse(A)||Date.parse(a.cells[colIndex].dataset.sort||'')||0; B = Date.parse(B)||Date.parse(b.cells[colIndex].dataset.sort||'')||0; return asc?A-B:B-A}
      A = (A||'').toLowerCase(); B = (B||'').toLowerCase();
      if(A < B) return asc ? -1 : 1;
      if(A > B) return asc ? 1 : -1;
      return 0;
    });
    rows.forEach(r=>tbody.appendChild(r));
    table.dataset.sortCol = String(colIndex);
    table.dataset.sortDir = asc ? 'asc' : 'desc';
  }

  function updateIndicators(activeCol, asc){
    // clear all visual indicators and aria attributes
    table.querySelectorAll('.sort-indicator').forEach(ind => { ind.classList.remove('asc','desc') });
    table.querySelectorAll('thead th').forEach(th => th.removeAttribute('aria-sort'));

    const btn = table.querySelector('.sort-btn[data-col="'+activeCol+'"]');
    if(btn){
      const ind = btn.querySelector('.sort-indicator');
      if(ind) ind.classList.add(asc ? 'asc' : 'desc');
      const th = btn.closest('th');
      if(th) th.setAttribute('aria-sort', asc ? 'ascending' : 'descending');
    }
  }

  // attach listeners to sort buttons and also make the whole th clickable
  Array.from(table.querySelectorAll('.sort-btn')).forEach(btn=>{
    const col = parseInt(btn.dataset.col,10);
    const type = btn.dataset.type || 'text';

    // click on the button
    btn.addEventListener('click', (ev) => {
      ev.stopPropagation();
      const current = table.dataset.sortCol === String(col) ? table.dataset.sortDir : null;
      const asc = current !== 'asc';
      sortTable(col, type, asc);
      updateIndicators(col, asc);
    });

    // make the parent th clickable (click anywhere in header cell)
    const th = btn.closest('th');
    if(th){
      th.classList.add('sortable');
      th.addEventListener('click', (ev) => {
        // ignore clicks that hit links/buttons inside the header to avoid double-handling
        if(ev.target.closest('button') || ev.target.tagName === 'BUTTON') return;
        btn.click();
      });
      // keyboard accessibility: allow Enter/Space on th to trigger sort
      th.tabIndex = 0;
      th.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter' || ev.key === ' '){
          ev.preventDefault();
          btn.click();
        }
      });
    }
  });

  // optional: set initial sort (by Created desc)
  const initialCol = 6;
  sortTable(initialCol, 'date', false);
  updateIndicators(initialCol, false);
})();
</script>
{% endblock %}