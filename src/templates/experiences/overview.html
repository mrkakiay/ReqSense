{% extends "base.html" %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-3">Traceability Matrix — Experiences & Requirements</h1>
  <p class="text-muted">Overview of experiences, linked requirements and stakeholders. Click column headers to sort.</p>

  <div class="table-responsive">
    <table id="trace-table" class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th><button class="sort-btn" data-col="0" data-type="num"># <span class="sort-indicator"></span></button></th>
          <th><button class="sort-btn" data-col="1" data-type="text">Experience <span class="sort-indicator"></span></button></th>
          <th><button class="sort-btn" data-col="2" data-type="text">Stakeholder <span class="sort-indicator"></span></button></th>
          <th><button class="sort-btn" data-col="3" data-type="text">Requirements <span class="sort-indicator"></span></button></th>
          <th><button class="sort-btn" data-col="4" data-type="text">Tags <span class="sort-indicator"></span></button></th>
          <th><button class="sort-btn" data-col="5" data-type="date">Created <span class="sort-indicator"></span></button></th>
          <th><button class="sort-btn" data-col="6" data-type="text">Impact <span class="sort-indicator"></span></button></th>
        </tr>
      </thead>
      <tbody>
      {% for e in experiences %}
        <tr>
          <td>{{ e.id }}</td>
          <td style="max-width:420px">
            <div>
              <strong>ID:</strong> {{ e.experience_id or ('#' ~ e.id) }}<br>
              <small class="text-muted">{{ (e.narrative_text[:260] ~ ('...' if e.narrative_text|length > 260 else '')) }}</small>
            </div>
          </td>
          <td>
            {% if e.stakeholder %}
              <div><strong>{{ e.stakeholder.name }}</strong></div>
              <small class="text-muted">{{ e.stakeholder.role or '' }}{% if e.stakeholder.department %} • {{ e.stakeholder.department }}{% endif %}</small><br>
              <small class="text-muted">{{ e.stakeholder.email or '' }}</small>
            {% else %}
              <small class="text-muted">—</small>
            {% endif %}
          </td>

          <td>
            {% if e.requirements and e.requirements|length > 0 %}
              <ul class="list-unstyled mb-0">
                {% for r in e.requirements %}
                  <li>
                    <strong>{{ r.requirement_id or ('R' ~ r.id) }}</strong>
                    <div class="small text-truncate" style="max-width:380px">{{ (r.requirement_text[:120] ~ ('...' if r.requirement_text|length > 120 else '')) }}</div>
                    <div class="small text-muted">Status: {{ r.status or '—' }} • Priority: {{ r.priority or '—' }}</div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <small class="text-muted">No linked requirements</small>
            {% endif %}
          </td>

          <td>
            {% set tags = e.context_tags or [] %}
            {% if tags %}
              {% for t in tags %}
                <span class="badge bg-secondary me-1 mb-1">{{ t }}</span>
              {% endfor %}
            {% else %}
              <small class="text-muted">—</small>
            {% endif %}
          </td>

          <td data-sort="{{ e.created_at.isoformat() if e.created_at }}">{{ e.created_at.strftime('%Y-%m-%d %H:%M') if e.created_at else '—' }}</td>
          <td>{{ e.impact_severity or '—' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.sort-btn {
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
  font-weight: 600;
  color: inherit;
}
.sort-btn:focus { outline: none; text-decoration: underline; }
.sort-indicator { display:inline-block; width:0.75rem; margin-left:0.35rem; }
.sort-indicator.asc::after  { content: "▲"; font-size:0.65rem; color:#0d6efd; }
.sort-indicator.desc::after { content: "▼"; font-size:0.65rem; color:#0d6efd; }
</style>

<script>
/* Column sorter with indicators and basic normalization for multi-value cells */
(function(){
  const table = document.getElementById('trace-table');
  if(!table) return;
  const tbody = table.tBodies[0];

  // attach handlers
  Array.from(table.querySelectorAll('.sort-btn')).forEach(btn=>{
    btn.addEventListener('click', () => {
      const col = parseInt(btn.dataset.col,10);
      const type = btn.dataset.type || 'text';
      // toggle asc/desc for same column
      const current = table.dataset.sortCol === String(col) ? table.dataset.sortDir : null;
      const asc = current !== 'asc';
      sortTable(col, type, asc);
      updateIndicators(col, asc);
    });
  });

  function normalizeCell(cell, colType){
    if(!cell) return '';
    // prefer explicit data-sort attribute
    if(cell.dataset && cell.dataset.sort) return cell.dataset.sort;
    // for tag badges or lists, join badges/text
    const badges = cell.querySelectorAll ? cell.querySelectorAll('.badge') : null;
    if(badges && badges.length){
      return Array.from(badges).map(b=>b.textContent.trim()).join(', ');
    }
    // for requirement lists, pick first strong or first list-item text
    const firstStrong = cell.querySelector && cell.querySelector('strong');
    if(firstStrong) return firstStrong.textContent.trim() + ' ' + (cell.textContent.replace(firstStrong.textContent,'').trim() || '');
    // default: plain text
    return cell.textContent.trim();
  }

  window.sortTable = function(colIndex, type='text', asc=true){
    const rows = Array.from(tbody.rows);
    rows.sort((a,b)=>{
      let A = normalizeCell(a.cells[colIndex], type);
      let B = normalizeCell(b.cells[colIndex], type);

      if(type === 'num'){
        A = parseFloat(A) || 0; B = parseFloat(B) || 0;
        return asc ? A - B : B - A;
      } else if(type === 'date'){
        const aVal = Date.parse(A) || Date.parse(a.cells[colIndex].dataset.sort || '') || 0;
        const bVal = Date.parse(B) || Date.parse(b.cells[colIndex].dataset.sort || '') || 0;
        return asc ? aVal - bVal : bVal - aVal;
      } else {
        A = (A||'').toLowerCase(); B = (B||'').toLowerCase();
        if(A < B) return asc ? -1 : 1;
        if(A > B) return asc ? 1 : -1;
        return 0;
      }
    });
    // re-attach in new order
    rows.forEach(r => tbody.appendChild(r));
    // store current sort
    table.dataset.sortCol = String(colIndex);
    table.dataset.sortDir = asc ? 'asc' : 'desc';
  };

  function updateIndicators(activeCol, asc){
    // clear all
    table.querySelectorAll('.sort-indicator').forEach(ind => ind.className = 'sort-indicator');
    // set active
    const btn = table.querySelector('.sort-btn[data-col="'+activeCol+'"]');
    if(btn){
      const ind = btn.querySelector('.sort-indicator');
      if(ind) ind.classList.add(asc ? 'asc' : 'desc');
    }
  }
})();
</script>
{% endblock %}