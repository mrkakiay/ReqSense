{% extends "base.html" %}
{% block title %}Traceability & Requirements — ReqSense{% endblock %}

{% block content %}
<div class="container my-3">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <h2>Traceability & Requirements</h2>
    <a class="btn" href="{{ url_for('experiences.overview') }}">Back to Experiences</a>
  </div>

  <div class="table-responsive">
    <table id="trace-table" class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th><button class="sort-btn" data-col="0" data-type="num">#</button></th>
          <th><button class="sort-btn" data-col="1" data-type="text">Experience</button></th>
          <th><button class="sort-btn" data-col="2" data-type="text">Stakeholder</button></th>
          <th><button class="sort-btn" data-col="3" data-type="text">Requirements</button></th>
          <th><button class="sort-btn" data-col="4" data-type="text">Tags</button></th>
          <th><button class="sort-btn" data-col="5" data-type="date">Created</button></th>
          <th><button class="sort-btn" data-col="6" data-type="text">Impact</button></th>
        </tr>
      </thead>
      <tbody>
      {% for e in experiences %}
        <tr id="exp-{{ e.id }}">
          <td>{{ e.id }}</td>
          <td>
            <div><strong>{{ e.experience_id or ('#' ~ e.id) }}</strong></div>
            <div class="text-muted">{{ (e.narrative_text[:220] ~ ('...' if e.narrative_text|length > 220 else '')) }}</div>
          </td>
          <td>
            {% if e.stakeholder %}
              <div>{{ e.stakeholder.name }}</div>
              <div class="text-muted">{{ e.stakeholder.role or '' }}</div>
            {% else %}
              <small class="text-muted">—</small>
            {% endif %}
          </td>
          <td>
            {% if e.requirements %}
              <ul class="list-unstyled mb-0">
                {% for r in e.requirements %}
                  <li><strong>{{ r.requirement_id or ('R' ~ r.id) }}</strong> — <small class="text-muted">{{ r.requirement_text[:100] }}</small></li>
                {% endfor %}
              </ul>
            {% else %}
              <small class="text-muted">—</small>
            {% endif %}
          </td>
          <td>
            {% for t in (e.context_tags or []) %}<span class="badge">{{ t }}</span>{% else %}<small class="text-muted">—</small>{% endfor %}
          </td>
          <td data-sort="{{ e.created_at.isoformat() if e.created_at }}">{{ e.created_at.strftime('%Y-%m-%d %H:%M') if e.created_at else '—' }}</td>
          <td>{{ e.impact_severity or '—' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.sort-btn{background:none;border:0;cursor:pointer;font-weight:600}
.badge{background:#e9ecef;padding:.2rem .45rem;border-radius:.35rem;margin-right:.25rem}
</style>

<script>
// same lightweight sorter: call sortTable(col,type,asc)
(function(){
  const table = document.getElementById('trace-table'); if(!table) return;
  const tbody = table.tBodies[0];
  Array.from(table.querySelectorAll('.sort-btn')).forEach(btn=>{
    btn.addEventListener('click', () => {
      const col = parseInt(btn.dataset.col,10);
      const type = btn.dataset.type || 'text';
      const asc = !(table.dataset.sortCol == col && table.dataset.sortDir == 'asc');
      sortTable(col,type,asc);
      table.dataset.sortCol = col; table.dataset.sortDir = asc ? 'asc' : 'desc';
    });
  });

  window.sortTable = function(col,type,asc=true){
    const rows = Array.from(tbody.rows);
    const getVal = (r) => {
      const c = r.cells[col];
      if(!c) return '';
      if(c.dataset.sort) return c.dataset.sort;
      const badges = c.querySelectorAll && c.querySelectorAll('.badge');
      if(badges && badges.length) return Array.from(badges).map(b=>b.textContent.trim()).join(', ');
      const strong = c.querySelector && c.querySelector('strong');
      if(strong) return strong.textContent.trim() + ' ' + c.textContent.replace(strong.textContent,'').trim();
      return c.textContent.trim();
    };
    rows.sort((a,b)=>{
      let A = getVal(a), B = getVal(b);
      if(type==='num'){A=parseFloat(A)||0;B=parseFloat(B)||0;return asc?A-B:B-A}
      if(type==='date'){A=Date.parse(A)||0;B=Date.parse(B)||0;return asc?A-B:B-A}
      A=(A||'').toLowerCase();B=(B||'').toLowerCase();
      if(A<B) return asc?-1:1; if(A>B) return asc?1:-1; return 0;
    });
    rows.forEach(r=>tbody.appendChild(r));
  };
})();
</script>
{% endblock %}